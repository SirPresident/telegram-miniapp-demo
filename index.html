<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Telegram Status</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: sans-serif; padding: 15px; background-color: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); }
        #userInfo { margin-bottom: 20px; }
        input[type="text"] { width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; border: 1px solid var(--tg-theme-hint-color); border-radius: 5px; }
        button { width: 100%; padding: 10px; background-color: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); border: none; border-radius: 5px; cursor: pointer; }
        #message { margin-top: 10px; font-size: 0.9em; }
    </style>
</head>
<body>
    <h1>My Telegram Status</h1>

    <div id="userInfo">
        Loading user info...
    </div>

    <input type="text" id="statusInput" placeholder="Enter your status">
    <button id="saveButton">Save Status</button>

    <div id="message"></div>

    <script>
        const tg = window.Telegram.WebApp;
        const BACKEND_URL_BASE = 'https://yummy-eyes-brake.loca.lt'; // Your current localtunnel URL

        let telegramUser = null;

        tg.ready();
        tg.expand();

        document.addEventListener('DOMContentLoaded', () => {
            // ... (user info loading logic) ...
        });

        async function fetchStatus(userId) {
            if (!BACKEND_URL_BASE || BACKEND_URL_BASE === 'YOUR_NGROK_HTTPS_URL_HERE') {
                document.getElementById('message').innerText = 'Backend URL not configured.';
                return;
            }
            document.getElementById('message').innerText = 'Fetching status...'; // Indicate activity
            try {
                const response = await fetch(`${BACKEND_URL_BASE}/api/status/${userId}/`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'bypass-tunnel-reminder': 'true' // <<< ADD THIS LINE
                        // For a real app, you'd also send tg.initData for backend validation here
                        // 'X-Telegram-Init-Data': tg.initData // Example for later
                    }
                });
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('statusInput').value = data.status_text || '';
                    document.getElementById('message').innerText = 'Status loaded.';
                } else if (response.status === 404) {
                    document.getElementById('message').innerText = 'No status saved yet.';
                    document.getElementById('statusInput').value = ''; // Clear input if no status
                } else {
                    // Try to get error message from backend if possible
                    let errorText = response.statusText;
                    try {
                        const errorData = await response.json();
                        errorText = errorData.error || errorText;
                    } catch (e) { /* ignore if response isn't json */ }
                    document.getElementById('message').innerText = `Error fetching status: ${response.status} ${errorText}`;
                }
            } catch (error) {
                document.getElementById('message').innerText = `Network error fetching status: ${error}`;
                console.error("Fetch status error:", error);
            }
        }

        async function saveStatus(userId, statusText) {
            if (!BACKEND_URL_BASE || BACKEND_URL_BASE === 'YOUR_NGROK_HTTPS_URL_HERE') {
                document.getElementById('message').innerText = 'Backend URL not configured.';
                return;
            }
            document.getElementById('message').innerText = 'Saving...';
            try {
                const response = await fetch(`${BACKEND_URL_BASE}/api/status/${userId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'bypass-tunnel-reminder': 'true', // <<< ADD THIS LINE
                        // You could also send tg.initData here for validation
                        // 'X-Telegram-Init-Data': tg.initData // Example for later
                    },
                    body: JSON.stringify({
                        status_text: statusText
                        // raw_init_data: tg.initData // For backend validation
                    })
                });
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('message').innerText = data.message || 'Status saved!';
                } else {
                    let errorText = response.statusText;
                    try {
                        const errorData = await response.json();
                        errorText = errorData.error || errorText;
                    } catch (e) { /* ignore if response isn't json */ }
                    document.getElementById('message').innerText = `Error saving status: ${response.status} ${errorText}`;
                }
            } catch (error) {
                document.getElementById('message').innerText = `Network error saving status: ${error}`;
                console.error("Save status error:", error);
            }
        }
    </script>
</body>
</html>