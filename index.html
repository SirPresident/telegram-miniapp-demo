<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My AI Processed Logs</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: sans-serif; padding: 0; margin:0; background-color: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); }
        #header { padding: 10px 15px; background-color: var(--tg-theme-secondary-bg-color); border-bottom: 1px solid var(--tg-theme-hint-color); }
        #userInfo { font-size: 0.9em; color: var(--tg-theme-hint-color); }
        #logsContainer { padding: 15px; }
        .log-entry { border: 1px solid var(--tg-theme-hint-color); border-radius: 8px; padding: 10px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .log-meta { font-size: 0.8em; color: var(--tg-theme-hint-color); margin-bottom: 8px; border-bottom: 1px dashed var(--tg-theme-hint-color); padding-bottom: 5px; }
        .log-original-note { font-style: italic; color: var(--tg-theme-hint-color); margin-bottom: 8px; font-size:0.9em; }
        .log-section { margin-top: 8px; }
        .log-section h3 { font-size: 0.95em; margin-top: 0; margin-bottom: 5px; color: var(--tg-theme-link-color); }
        .log-section ul { list-style-type: disc; margin: 0 0 5px 20px; padding: 0; }
        .log-section li { margin-bottom: 3px; }
        #loadingMessage { text-align: center; padding: 20px; }
        .tag { background-color: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); padding: 2px 6px; border-radius: 4px; font-size:0.8em; margin-right:5px; display:inline-block; margin-bottom:3px;}
    </style>
</head>
<body>
    <div id="header"><h1>My AI Processed Logs</h1><div id="userInfo">Loading user...</div></div>
    <div id="logsContainer"><div id="loadingMessage">Loading logs...</div></div>

    <script>
        const tg = window.Telegram.WebApp;
        const BACKEND_URL_BASE = 'https://finarfin-bot-subdomain.loca.lt'; // Replace!
        let telegramUser = null;

        tg.ready(); tg.expand();

        document.addEventListener('DOMContentLoaded', () => {
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                telegramUser = tg.initDataUnsafe.user;
                document.getElementById('userInfo').innerText = `Logs for: ${telegramUser.first_name || ''} (@${telegramUser.username || 'N/A'})`;
                if (telegramUser.id) fetchAndDisplayLogs();
                else document.getElementById('loadingMessage').innerText = "Cannot load logs: User ID unavailable.";
            } else {
                document.getElementById('userInfo').innerText = "Could not load Telegram user data.";
                document.getElementById('loadingMessage').innerText = "Cannot load logs: User data unavailable.";
            }
        });

        async function fetchAndDisplayLogs() {
            const container = document.getElementById('logsContainer');
            const loadingDiv = document.getElementById('loadingMessage');
            loadingDiv.innerText = 'Refreshing logs...'; loadingDiv.style.display = 'block';
            container.innerHTML = ''; container.appendChild(loadingDiv);

            if (!BACKEND_URL_BASE || BACKEND_URL_BASE.includes('your-localtunnel')) {
                loadingDiv.innerText = 'Backend URL not configured.'; return;
            }
            if (!telegramUser || !telegramUser.id) {
                loadingDiv.innerText = 'User ID missing for fetching logs.'; return;
            }

            const fetchUrl = `${BACKEND_URL_BASE}/api/get_user_logs/?telegram_id=${telegramUser.id}`;
            console.log("Fetching logs from:", fetchUrl);

            try {
                const response = await fetch(fetchUrl, {
                    method: 'GET',
                    headers: {'Content-Type': 'application/json', 'bypass-tunnel-reminder': 'true'}
                });
                if (response.ok) {
                    const data = await response.json();
                    loadingDiv.style.display = 'none';
                    if (data.logs && data.logs.length > 0) {
                        data.logs.forEach(log => {
                            const entryDiv = document.createElement('div');
                            entryDiv.className = 'log-entry';
                            let htmlContent = `<div class="log-meta">Logged: ${log.logged_at}</div>`;
                            if(log.original_note) {
                                htmlContent += `<div class="log-original-note"><strong>Original:</strong> ${escapeHtml(log.original_note)}</div>`;
                            }

                            if (log.mood_label) {
                                htmlContent += `<div class="log-section"><h3>Mood</h3><span class="tag">${escapeHtml(log.mood_label)} (${log.mood_score || 'N/A'})</span></div>`;
                            }
                            if (log.health && log.health.length > 0) {
                                htmlContent += `<div class="log-section"><h3>Health</h3><ul>`;
                                log.health.forEach(h => { htmlContent += `<li>${escapeHtml(h)}</li>`; });
                                htmlContent += `</ul></div>`;
                            }
                            if (log.activity && log.activity.length > 0) {
                                htmlContent += `<div class="log-section"><h3>Activity</h3><ul>`;
                                log.activity.forEach(a => { htmlContent += `<li>${escapeHtml(a)}</li>`; });
                                htmlContent += `</ul></div>`;
                            }
                            // Add similar sections for diet and important if you implement them

                            entryDiv.innerHTML = htmlContent;
                            container.appendChild(entryDiv);
                        });
                    } else { container.innerHTML = '<p style="text-align:center;">No logs found yet. Send me a note in the chat!</p>'; }
                } else {
                    let errTxt = response.statusText; try {const eD = await response.json(); errTxt = eD.error || errTxt;} catch(e){}
                    loadingDiv.innerText = `Error loading logs: ${response.status} ${errTxt}`;
                }
            } catch (error) {
                loadingDiv.innerText = `Network error loading logs: ${error}`;
                console.error("Fetch logs error:", error);
            }
        }
        // function escapeHtml(unsafe) { // Keep this helper function
        //     if (typeof unsafe !== 'string') return '';
        //     return unsafe.replace(/&/g, "&").replace(/</g, "<").replace(/>/g, ">").replace(/"/g, """).replace(/'/g, "'");
        // }
        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') {
                return '';
            }
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>