<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Telegram Status</title>
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: sans-serif; padding: 15px; background-color: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); }
        #userInfo { margin-bottom: 20px; }
        input[type="text"] { width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; border: 1px solid var(--tg-theme-hint-color); border-radius: 5px; }
        button { width: 100%; padding: 10px; background-color: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); border: none; border-radius: 5px; cursor: pointer; }
        #message { margin-top: 10px; font-size: 0.9em; }
    </style>
</head>
<body>
    <h1>My Telegram Status</h1>

    <div id="userInfo">
        Loading user info...
    </div>

    <input type="text" id="statusInput" placeholder="Enter your status">
    <button id="saveButton">Save Status</button>

    <div id="message"></div>

    <script>
        const tg = window.Telegram.WebApp;
        // !! IMPORTANT: This URL must point to your live backend (e.g., localtunnel URL) !!
        const BACKEND_URL_BASE = 'https://finarfin-bot-subdomain.loca.lt'; // e.g., 'https://yummy-eyes-brake.loca.lt'

        let telegramUser = null;

        // Inform Telegram the app is ready and expand it
        tg.ready();
        tg.expand();

        document.addEventListener('DOMContentLoaded', () => {
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                telegramUser = tg.initDataUnsafe.user;
                document.getElementById('userInfo').innerText = `Hello, ${telegramUser.first_name || ''} ${telegramUser.last_name || ''} (@${telegramUser.username || 'N/A'})! Your ID: ${telegramUser.id}`;

                console.log("Telegram User for fetchStatus:", telegramUser); // DEBUG
                if (telegramUser && telegramUser.id) {
                    fetchStatus(telegramUser.id);
                } else {
                    document.getElementById('message').innerText = "Error: Telegram user ID not available for fetching status.";
                    console.error("Telegram user ID missing for fetchStatus", telegramUser);
                }
            } else {
                document.getElementById('userInfo').innerText = "Could not load Telegram user data. Are you running this inside Telegram?";
                document.getElementById('saveButton').disabled = true;
                document.getElementById('statusInput').disabled = true;
                console.error("Telegram.WebApp.initDataUnsafe.user is not available.");
            }

            document.getElementById('saveButton').addEventListener('click', () => {
                if (!telegramUser || !telegramUser.id) {
                    document.getElementById('message').innerText = "Cannot save: User info not loaded.";
                    return;
                }
                const statusText = document.getElementById('statusInput').value;
                saveStatus(telegramUser.id, statusText);
            });
        });

        async function fetchStatus(userId) {
            if (!BACKEND_URL_BASE || BACKEND_URL_BASE.includes('YOUR_') ) { // Basic check
                document.getElementById('message').innerText = 'Backend URL not configured.';
                return;
            }
            document.getElementById('message').innerText = 'Fetching status...';
            console.log("Attempting fetch for user:", userId); // DEBUG
            try {
                const response = await fetch(`${BACKEND_URL_BASE}/api/status/${userId}/`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'bypass-tunnel-reminder': 'true' // To bypass localtunnel interstitial
                        // 'User-Agent': 'MyTMA-StatusApp/1.0' // Alternative bypass
                    }
                });
                console.log("Fetch response status:", response.status); // DEBUG
                console.log("Fetch response.ok:", response.ok); // DEBUG

                if (response.ok) { // status 200-299
                    const data = await response.json();
                    document.getElementById('statusInput').value = data.status_text || '';
                    document.getElementById('message').innerText = 'Status loaded.';
                } else if (response.status === 404) {
                    console.log("Handling 404: No status saved yet."); // DEBUG
                    document.getElementById('message').innerText = 'No status saved yet.';
                    document.getElementById('statusInput').value = '';
                } else {
                    let errorText = response.statusText;
                    try {
                        const errorData = await response.json(); // Try to get backend error
                        errorText = errorData.error || errorText;
                    } catch (e) { /* ignore if response isn't json */ }
                    document.getElementById('message').innerText = `Error fetching status: ${response.status} ${errorText}`;
                    console.error(`Error fetching status: ${response.status}`, errorText);
                }
            } catch (error) {
                console.error("CRITICAL ERROR in fetchStatus catch block:", error); // DEBUG
                document.getElementById('message').innerText = `Network error fetching status: ${error}`;
            }
        }

        async function saveStatus(userId, statusText) {
            if (!BACKEND_URL_BASE || BACKEND_URL_BASE.includes('YOUR_')) { // Basic check
                document.getElementById('message').innerText = 'Backend URL not configured.';
                return;
            }
            document.getElementById('message').innerText = 'Saving...';
            console.log("Attempting to save status for user:", userId, "Status:", statusText); // DEBUG
            try {
                const response = await fetch(`${BACKEND_URL_BASE}/api/status/${userId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'bypass-tunnel-reminder': 'true', // To bypass localtunnel interstitial
                        // 'User-Agent': 'MyTMA-StatusApp/1.0' // Alternative bypass
                        // 'X-Telegram-Init-Data': tg.initData // For backend validation later
                    },
                    body: JSON.stringify({
                        status_text: statusText,
                        // raw_init_data: tg.initData // For backend validation later
                    })
                });
                console.log("Save response status:", response.status); // DEBUG

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('message').innerText = data.message || 'Status saved!';
                } else {
                    let errorText = response.statusText;
                    try {
                        const errorData = await response.json();
                        errorText = errorData.error || errorText;
                    } catch (e) { /* ignore if response isn't json */ }
                    document.getElementById('message').innerText = `Error saving status: ${response.status} ${errorText}`;
                    console.error(`Error saving status: ${response.status}`, errorText);
                }
            } catch (error) {
                console.error("CRITICAL ERROR in saveStatus catch block:", error); // DEBUG
                document.getElementById('message').innerText = `Network error saving status: ${error}`;
            }
        }
    </script>
</body>
</html>