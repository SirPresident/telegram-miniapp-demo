<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Saved Notes</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: sans-serif; padding: 15px;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            margin: 0;
        }
        #header {
            padding: 10px 15px;
            background-color: var(--tg-theme-secondary-bg-color); /* Slightly different bg for header */
            border-bottom: 1px solid var(--tg-theme-hint-color);
        }
        #userInfo { font-size: 0.9em; color: var(--tg-theme-hint-color); }
        #messagesContainer { padding: 15px; }
        .message-item {
            background-color: var(--tg-theme-bg-color); /* Or var(--tg-theme-secondary-bg-color) for contrast */
            border: 1px solid var(--tg-theme-hint-color);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .message-meta { font-size: 0.8em; color: var(--tg-theme-hint-color); margin-bottom: 5px; }
        .message-text { white-space: pre-wrap; word-break: break-word; }
        #loadingMessage { text-align: center; padding: 20px; }
        /* Basic button styling (if you add refresh button) */
        button {
            padding: 8px 15px; background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color); border: none;
            border-radius: 5px; cursor: pointer; margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>My Saved Notes</h1>
        <div id="userInfo">Loading user...</div>
    </div>

    <div id="messagesContainer">
        <div id="loadingMessage">Loading messages...</div>
    </div>

    <!-- Optional: Refresh button -->
    <!-- <div style="text-align: center; padding-bottom: 15px;">
        <button id="refreshButton">Refresh Notes</button>
    </div> -->

    <script>
        const tg = window.Telegram.WebApp;
        // !! IMPORTANT: This URL must point to your live backend !!
        const BACKEND_URL_BASE = 'https://finarfin-bot-subdomain.loca.lt'; // Your localtunnel base

        let telegramUser = null;

        tg.ready();
        tg.expand(); // Expand to full height

        document.addEventListener('DOMContentLoaded', () => {
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                telegramUser = tg.initDataUnsafe.user;
                document.getElementById('userInfo').innerText = `User: ${telegramUser.first_name || ''} (@${telegramUser.username || 'N/A'})`;
                fetchAndDisplayMessages(); // Fetch messages on load
            } else {
                document.getElementById('userInfo').innerText = "Could not load Telegram user data.";
                document.getElementById('loadingMessage').innerText = "Cannot load messages: User data unavailable.";
                console.error("Telegram.WebApp.initDataUnsafe.user is not available.");
            }

            // Optional: Refresh button functionality
            // const refreshBtn = document.getElementById('refreshButton');
            // if (refreshBtn) {
            //     refreshBtn.addEventListener('click', fetchAndDisplayMessages);
            // }
        });

        async function fetchAndDisplayMessages() {
            const messagesContainer = document.getElementById('messagesContainer');
            const loadingMessageDiv = document.getElementById('loadingMessage');
            loadingMessageDiv.innerText = 'Refreshing messages...';
            loadingMessageDiv.style.display = 'block'; // Show loading message
            messagesContainer.innerHTML = '';
            messagesContainer.appendChild(loadingMessageDiv);

            if (!BACKEND_URL_BASE || BACKEND_URL_BASE.includes('YOUR_')) {
                loadingMessageDiv.innerText = 'Backend URL not configured.';
                return;
            }

            // --- KEY CHANGE: Check for telegramUser and use user-specific fetch URL ---
            if (!telegramUser || !telegramUser.id) {
                loadingMessageDiv.innerText = 'Cannot load messages: Telegram user ID not available.';
                console.error("Telegram user ID missing for fetching messages.");
                return;
            }
            const fetchUrl = `${BACKEND_URL_BASE}/api/messages/?telegram_id=${telegramUser.id}`;
            // --- END KEY CHANGE ---

            loadingMessageDiv.innerText = 'Refreshing messages...';
            console.log("Fetching user-specific messages from:", fetchUrl);

            try {
                const response = await fetch(fetchUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'bypass-tunnel-reminder': 'true'
                        // For production with initData validation:
                        // 'X-Telegram-Init-Data': tg.initData
                    }
                });
                console.log("Response received, status:", response.status, "ok:", response.ok);

                if (response.ok) {
                    console.log("Response is OK, parsing JSON...");
                    const data = await response.json();
                    console.log("JSON parsed:", data);

                    loadingMessageDiv.style.display = 'none';

                    if (data.messages && data.messages.length > 0) {
                        data.messages.forEach(msg => {
                            const msgDiv = document.createElement('div');
                            msgDiv.className = 'message-item';
                            msgDiv.innerHTML = `
                                <div class="message-meta">
                                    From: ${msg.telegram_username || msg.telegram_user_id}
                                    <span style="float: right;">${msg.received_at}</span>
                                </div>
                                <div class="message-text">${escapeHtml(msg.text)}</div>
                            `;
                            messagesContainer.appendChild(msgDiv);
                        });
                    } else {
                        messagesContainer.innerHTML = '<p style="text-align:center;">No notes saved yet.</p>';
                    }
                } else {
                    console.error("Response not OK. Status:", response.status);
                    let errorText = response.statusText;
                    try { const errorData = await response.json(); errorText = errorData.error || errorText; }
                    catch (e) { /* ignore */ }
                    loadingMessageDiv.innerText = `Error loading messages: ${response.status} ${errorText}`;
                    console.error(`Error loading messages: ${response.status}`, errorText);
                }
            } catch (error) {
                loadingMessageDiv.innerText = `Network error loading messages: ${error}`;
                console.error("Network error in fetchAndDisplayMessages:", error);
            }
        }

        // Helper to prevent XSS if displaying user-generated text
        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') {
                return '';
            }
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

    </script>
</body>
</html>