<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My AI Processed Logs & Mood Chart</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Chart.js + Luxon + Zoom -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.3/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>
    <!-- noUiSlider -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>
    <style>
        :root {
            --bg-color: #f8fafb;
            --bg-gradient-start: #f8fafb;
            --bg-gradient-end:   #e8ecf0;
            --shadow-dark: rgba(0,0,0,0.08);
            --shadow-light: rgba(255,255,255,0.7);
            --text-color: #6c7a89;
            --chart-line: #36A2EB;
            --chart-grad-start: rgba(54,162,235,0.6);
            --chart-grad-end:   rgba(54,162,235,0.1);
            --highlight-above:  rgba(144,238,144,0.4); /* Used for active tab */
            --highlight-below:  rgba(173,216,230,0.2); /* Used for inactive tab bg, tags */
            --btn-bg: #f8fafb;
        }
        .dark {
            --bg-color: #1f1f1f;
            --bg-gradient-start: #1f1f1f;
            --bg-gradient-end:   #262626;
            --shadow-dark: rgba(0,0,0,0.6);
            --shadow-light: rgba(255,255,255,0.1);
            --text-color: #d1d1d1;
            --chart-line: #dfe6ef; /* Softer line color for dark mode */
            --chart-grad-start: rgba(78,154,241,0.6);
            --chart-grad-end:   rgba(78,154,241,0.1);
            --highlight-above:  rgba(106,178,242,0.5); /* Adjusted active tab for dark */
            --highlight-below:  rgba(50,60,70,0.5);    /* Adjusted inactive tab/tags for dark */
            --btn-bg: #1f1f1f;
        }
        * { box-sizing:border-box; margin:0; padding:0; }
        body {
            background: linear-gradient(145deg,var(--bg-gradient-start),var(--bg-gradient-end));
            font-family: 'Segoe UI',sans-serif; color:var(--text-color);
            display:flex; flex-direction:column; align-items:center;
            min-height:100vh; padding:1rem; transition: background 0.3s, color 0.3s; /* Added padding to body */
        }
        .capsule-tabs { display: flex; align-items: center; gap: 1.5rem; margin-bottom: 1.5rem; width:100%; max-width:900px; padding: 0 1rem; /* Ensure padding consistency */ }
        .switch { position:relative; width:60px; height:34px; /* margin-bottom:0; removed from here, handled by capsule-tabs gap */ }
        .switch input { opacity:0; width:0; height:0; }
        .slider-switch { position:absolute; top:0; left:0; right:0; bottom:0; background:var(--bg-color); box-shadow:4px 4px 12px var(--shadow-dark), -4px -4px 12px var(--shadow-light); border-radius:34px; cursor:pointer; transition:0.3s; }
        .slider-switch:before { content:""; position:absolute; width:26px; height:26px; left:4px; bottom:4px; background:var(--bg-gradient-start); box-shadow:2px 2px 6px var(--shadow-dark), -2px -2px 6px var(--shadow-light); border-radius:50%; transition:0.3s; }
        input:checked + .slider-switch { box-shadow: inset 4px 4px 12px var(--shadow-dark), inset -4px -4px 12px var(--shadow-light); }
        input:checked + .slider-switch:before { transform:translateX(26px); }
        
        .capsule-tab-group { display: flex; gap: 1.2rem; background: var(--bg-color); border-radius: 30px; padding: 8px 12px; box-shadow: 8px 8px 24px var(--shadow-dark), -8px -8px 24px var(--shadow-light); }
        .capsule-tab-btn { position: relative; width: 48px; height: 48px; border-radius: 50%; background: var(--highlight-below); box-shadow: 2px 2px 8px var(--shadow-dark), -2px -2px 8px var(--shadow-light); border: none; outline: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: width 0.35s cubic-bezier(.4,2,.6,1), border-radius 0.35s cubic-bezier(.4,2,.6,1), background 0.25s, box-shadow 0.25s; overflow: hidden; padding: 0; margin: 0; min-width: 48px; z-index: 1; }
        .capsule-tab-btn .capsule-icon, .capsule-tab-btn .capsule-text { position: absolute; left: 0; right: 0; top: 0; bottom: 0; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; font-size: 1.5rem; transition: opacity 0.25s cubic-bezier(.4,2,.6,1), transform 0.35s cubic-bezier(.4,2,.6,1); pointer-events: none; user-select: none; }
        .capsule-tab-btn .capsule-text { opacity: 0; transform: translateY(10px); font-size: 1.1rem; font-weight: 500; letter-spacing: 0.01em; color: var(--text-color); }
        .capsule-tab-btn.active { width: 130px; border-radius: 24px; background: var(--highlight-above); }
        .capsule-tab-btn.active .capsule-icon { opacity: 0; transform: translateY(-10px) scale(0.7); }
        .capsule-tab-btn.active .capsule-text { opacity: 1; transform: translateY(0); }

        .tab-content { width:100%; } /* Takes full width of its parent */
        .content { display:none; } /* Hide inactive tabs */
        .content.active { display:block; } /* Show active tab */

        .container { width:100%; max-width:900px; }
        .box { background:var(--bg-color); border-radius:20px; padding:1.5rem; /* Adjusted padding */ box-shadow: 10px 10px 30px var(--shadow-dark), -10px -10px 30px var(--shadow-light), inset 4px 4px 15px var(--shadow-dark), inset -4px -4px 15px var(--shadow-light); transition:0.3s; }
        #header { margin-bottom:1rem; }
        #header h1 { font-size:1.4rem; color: var(--text-color)}
        #userInfo { font-size: 0.9em; color: var(--text-color); /* Make user info more prominent */ }

        .inner { display:flex; align-items:flex-start; overflow-x:auto; }
        #slider { flex:0 0 26px; margin-right:20px; /* Adjusted margin */ background: var(--bg-color); box-shadow: 4px 4px 12px var(--shadow-dark), -4px -4px 12px var(--shadow-light); border-radius: 10px; min-width: 26px; width: 26px; display: flex; align-items: stretch; justify-content: center; }
        #slider .noUi-base { background: transparent; box-shadow: none; border: none !important; }
        #slider .noUi-connect { background: var(--bg-color); box-shadow: inset 4px 4px 12px var(--shadow-dark), inset -4px -4px 12px var(--shadow-light); }
        #slider .noUi-handle { width: 26px; height: 26px; border-radius: 50%; background: var(--bg-gradient-start); box-shadow: 2px 2px 6px var(--shadow-dark), -2px -2px 6px var(--shadow-light); border: none; top: auto; transform: translateY(0); transition: box-shadow 0.3s; cursor: grab; }
        #slider .noUi-handle:before, #slider .noUi-handle:after { display: none; }
        #slider .noUi-handle:active { box-shadow: inset 2px 2px 6px var(--shadow-dark), inset -2px -2px 6px var(--shadow-light); }
        #slider .noUi-tooltip { background: var(--bg-color); color: var(--text-color); border-radius: 10px; box-shadow: 2px 2px 6px var(--shadow-dark), -2px -2px 6px var(--shadow-light); border: none; font-size: 0.95em; padding: 4px 8px; }
        
        .chart-wrap { flex:1 1 0; min-width:200px; }
        .chart-wrap canvas { width:100%!important; height:300px!important; border-radius:12px; }
        .segment-label { text-align:center; margin:1rem 0 0.5rem; font-weight:bold; }
        .nav-buttons { display:flex; justify-content:space-between; margin-top:0.5rem; }
        .nav-buttons button { background:var(--btn-bg); color:var(--text-color); border:none; padding:.5rem 1rem; border-radius:8px; box-shadow:4px 4px 10px var(--shadow-dark), -4px -4px 10px var(--shadow-light); font-size:1rem; cursor:pointer; transition:0.2s; }
        .nav-buttons button:disabled { opacity:0.4; cursor:default; }
        .nav-buttons button:active { transform:translateY(2px); box-shadow: inset 2px 2px 6px var(--shadow-dark); }
        
        .panels { display: flex; gap: 1rem; margin-top: 1.5rem; padding: 0; /* Removed panel padding, rely on individual panel padding */ flex-wrap: wrap; }
        .panel { flex: 1; background: var(--bg-color); border-radius: 12px; padding: 1rem; box-shadow: 4px 4px 12px var(--shadow-dark), -4px -4px 12px var(--shadow-light), inset 2px 2px 6px var(--shadow-dark), -2px -2px 6px var(--shadow-light); transition: background 0.3s, box-shadow 0.3s; min-width: 200px; /* Adjusted min-width */ box-sizing: border-box; }
        .panel h3 { margin: 0 0 0.75rem; font-size: 1.1rem; color: var(--text-color); /* padding: 1rem 0 0.5rem 0; removed padding */ }
        .panel div > div { margin-bottom: 0.5em; } /* Spacing for diet categories */
        .panel .tag { margin-bottom: 0.3em; } /* Ensure tags have bottom margin if they wrap */

        #logsContainer { margin-top:2rem; }
        .log-entry { border: 1px solid var(--shadow-dark); border-radius: 8px; padding: 10px; margin-bottom: 15px; box-shadow: 0 1px 3px var(--shadow-dark); background: var(--bg-color); }
        .log-meta { font-size: 0.8em; color: var(--text-color); margin-bottom: 8px; border-bottom: 1px dashed var(--shadow-dark); padding-bottom: 5px; }
        .log-original-note { font-style: italic; color: var(--text-color); margin-bottom: 8px; font-size:0.9em; }
        .log-section { margin-top: 8px; }
        .log-section h3 { font-size: 0.95em; margin-top: 0; margin-bottom: 5px; color: var(--chart-line); /* Using chart line color for consistency */ }
        .log-section ul { list-style-type: disc; margin: 0 0 5px 20px; padding: 0; } /* Original style for lists */
        .log-section > div { margin-bottom: 0.5em; } /* For non-list items like mood tag */
        .tag { background-color: var(--highlight-below); color: var(--text-color); padding: 2px 6px; border-radius: 4px; font-size:0.8em; margin-right:5px; display:inline-block; margin-bottom:3px;}
        #loadingMessage { text-align: center; padding: 20px; }

        @media(max-width:768px){ /* Broader breakpoint for panel stacking */
            .panels { flex-direction: column; }
            .panel { min-width: 0; width: 100%; }
        }
        @media(max-width:600px){
            .inner{flex-wrap:nowrap;} /* Keep chart and slider side-by-side if possible */
            body { padding: 1rem 0.5rem; } /* Reduce body padding */
            .box { padding: 1rem; }
            .capsule-tabs { gap: 0.5rem; padding: 0 0.5rem;}
        }
         @media (max-width: 500px) {
            .capsule-tab-group { gap: 0.5rem; padding: 6px 4px; }
            .capsule-tab-btn, .capsule-tab-btn.active { width: 40px; min-width: 40px; height: 40px; }
            .capsule-tab-btn.active { width: 100px; } /* Adjusted for shorter text like "Logs" or "Stats" */
            .capsule-tab-btn .capsule-text { font-size: 1rem; }
        }
    </style>
</head>
<body>
    <div class="capsule-tabs">
        <label class="switch" style="margin-bottom:0;">
            <input type="checkbox" id="themeToggle">
            <span class="slider-switch"></span>
        </label>
        <div class="capsule-tab-group">
            <button class="capsule-tab-btn active" id="tab-history" type="button">
                <span class="capsule-icon">📅</span> <span class="capsule-text">History</span>
            </button>
            <button class="capsule-tab-btn" id="tab-levelup" type="button">
                <span class="capsule-icon">⬆️</span> <span class="capsule-text">Level Up</span>
            </button>
        </div>
    </div>

    <div class="tab-content" style="width:100%;">
        <div id="history" class="content active">
            <div class="container">
                <div class="box">
                    <div id="header" style="margin-bottom:1rem;">
                        <h1 style="font-size:1.4rem;">My AI Processed Logs</h1>
                        <div id="userInfo">Loading user...</div>
                    </div>
                    <div class="inner">
                        <div id="slider"></div>
                        <div class="chart-wrap"> <canvas id="moodScoreChart"></canvas> </div>
                    </div>
                    <div class="segment-label" id="segmentLabel"></div>
                    <div class="nav-buttons">
                        <button id="prevWeekBtn">Previous</button>
                        <button id="nextWeekBtn">Next</button>
                    </div>
                    <div class="panels">
                        <div class="panel"><h3>Dietary</h3> <div id="dietPanel"></div> </div>
                        <div class="panel"><h3>Health</h3> <div id="healthPanel"></div> </div>
                        <div class="panel"><h3>Activities</h3> <div id="activityPanel"></div> </div>
                    </div>
                    <div id="logsContainer" style="margin-top:2rem;">
                        <div id="loadingMessage">Loading logs...</div>
                    </div>
                </div>
            </div>
        </div>
        <div id="levelup" class="content" style="display:none;">
            <div class="container">
                <div class="box" style="text-align:center;">
                    <h2 style="margin-bottom:1rem;">Level Up</h2>
                    <p>Coming soon: gamified progress, achievements, and more!</p>
                </div>
            </div>
        </div>
    </div>

    <script>
    // Capsule Tab Logic
    document.addEventListener('DOMContentLoaded', () => {
        const tabBtns = [
            { btn: document.getElementById('tab-history'), content: document.getElementById('history') },
            { btn: document.getElementById('tab-levelup'), content: document.getElementById('levelup') }
        ];
        function activateTab(idx) {
            tabBtns.forEach((tab, i) => {
                tab.btn.classList.toggle('active', i === idx);
                tab.content.classList.toggle('active', i === idx);
                tab.content.style.display = (i === idx) ? '' : 'none';
            });
        }
        tabBtns.forEach((tab, idx) => tab.btn.addEventListener('click', () => activateTab(idx)));
        activateTab(0); // Activate first tab by default
    });
    </script>

    <script>
        // Theme toggle logic
        const themeToggle = document.getElementById('themeToggle'); // Changed variable name for clarity
        const currentTheme = localStorage.getItem('theme');
        if (currentTheme === 'dark') {
            document.body.classList.add('dark');
            themeToggle.checked = true;
        }
        themeToggle.addEventListener('change', e => {
            const isDark = e.target.checked;
            document.body.classList.toggle('dark', isDark);
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            if (window.moodChartInstance) { // Ensure chart exists before updating
                // Update chart colors for theme change
                moodChartInstance.options.scales.x.ticks.color = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
                moodChartInstance.options.scales.y.ticks.color = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
                moodChartInstance.options.scales.y.grid.color = getComputedStyle(document.documentElement).getPropertyValue('--shadow-dark').trim();
                moodChartInstance.data.datasets[0].borderColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-line').trim();
                moodChartInstance.data.datasets[0].backgroundColor = makeGradient(moodChartInstance.ctx); // Redraw gradient
                
                // Recolor points based on current thresholds and new theme
                const [minThreshold, maxThreshold] = slider.noUiSlider.get();
                const baseColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-line').trim();
                const highlightColor = 'seagreen'; // Could also be a CSS variable
                const weekMoodDataForChart = getWeekMoodData(idx);
                 moodChartInstance.data.datasets[0].pointBackgroundColor =
                    weekMoodDataForChart.map(point => {
                        return (point.y !== null && point.y >= +minThreshold && point.y <= +maxThreshold) ? highlightColor : baseColor;
                    });
                moodChartInstance.update();
            }
        });
    </script>

    <script>
        const tg = window.Telegram.WebApp;
        const BACKEND_URL_BASE = 'https://finarfin-bot-subdomain.loca.lt'; // Your actual backend URL
        let telegramUser = null;
        let allUserLogs = [];
        let moodChartInstance = null;
        let weekSegments = [];
        let currentWeekIndex = 0; // Renamed from idx for clarity
        let slider = null; // noUiSlider instance

        tg.ready();
        tg.expand();

        document.addEventListener('DOMContentLoaded', () => {
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                telegramUser = tg.initDataUnsafe.user;
                document.getElementById('userInfo').innerText = `Logs for: ${telegramUser.first_name || ''} (@${telegramUser.username || 'N/A'})`;
                if (telegramUser.id) {
                    fetchAllLogsAndSetupChart();
                } else {
                    document.getElementById('loadingMessage').innerText = "Cannot load logs: User ID unavailable.";
                }
            } else {
                document.getElementById('userInfo').innerText = "Could not load Telegram user data.";
                document.getElementById('loadingMessage').innerText = "Cannot load logs: User data unavailable.";
            }

            document.getElementById('prevWeekBtn').addEventListener('click', () => {
                if (currentWeekIndex > 0) {
                    currentWeekIndex--;
                    updateView();
                }
            });
            document.getElementById('nextWeekBtn').addEventListener('click', () => {
                if (currentWeekIndex < weekSegments.length - 1) {
                    currentWeekIndex++;
                    updateView();
                }
            });
        });

        async function fetchAllLogsAndSetupChart() {
            const loadingDiv = document.getElementById('loadingMessage');
            loadingDiv.innerText = 'Loading all logs...'; // Simplified message
            loadingDiv.style.display = 'block';

            if (!telegramUser || !telegramUser.id) {
                loadingDiv.innerText = 'User ID missing for fetching logs.'; return;
            }
            const fetchUrl = `${BACKEND_URL_BASE}/api/get_user_logs/?telegram_id=${telegramUser.id}`;
            try {
                const response = await fetch(fetchUrl, {
                    method: 'GET',
                    headers: {'Content-Type': 'application/json', 'bypass-tunnel-reminder': 'true'}
                });
                if (response.ok) {
                    const data = await response.json();
                    loadingDiv.style.display = 'none';
                    if (data.logs && data.logs.length > 0) {
                        allUserLogs = data.logs.map(log => ({
                            ...log,
                            // Ensure logged_at_date is parsed robustly, assuming UTC from backend
                            logged_at_date: new Date(log.logged_at.replace(' ', 'T') + (log.logged_at.endsWith('Z') ? '' : 'Z'))
                        })).sort((a, b) => a.logged_at_date - b.logged_at_date); // Sort ascending for week splitting

                        weekSegments = splitLogsToWeeks(allUserLogs);
                        if (weekSegments.length > 0) {
                            currentWeekIndex = weekSegments.length - 1; // Show latest week
                            setupChartAndSlider(); // Setup chart and slider once logs are fetched
                            updateView(); // Initial view update
                        } else {
                             document.getElementById('logsContainer').innerHTML = '<p style="text-align:center;">No weekly segments found.</p>';
                        }
                        displayLogEntries(allUserLogs); // Display all logs initially
                    } else {
                        document.getElementById('logsContainer').innerHTML = '<p style="text-align:center;">No logs found yet. Send a note in the chat!</p>';
                         // Optionally disable chart/slider elements if no data
                        document.getElementById('slider').style.display = 'none';
                        document.getElementById('moodScoreChart').style.display = 'none';
                        document.getElementById('prevWeekBtn').disabled = true;
                        document.getElementById('nextWeekBtn').disabled = true;
                    }
                } else {
                    let errTxt = response.statusText; try {const eD = await response.json(); errTxt = eD.error || errTxt;} catch(e){}
                    loadingDiv.innerText = `Error loading logs: ${response.status} ${errTxt}`;
                }
            } catch (error) {
                loadingDiv.innerText = `Network error loading logs: ${error}`;
                console.error("Fetch logs error:", error);
            }
        }

        function splitLogsToWeeks(logs) {
            if (!logs || !logs.length) return [];
            const weeks = [];
            let currentWeek = [];
            // Ensure logs are sorted by date before splitting
            const sortedLogs = [...logs].sort((a, b) => a.logged_at_date - b.logged_at_date);
            
            let weekStartDate = getStartOfWeek(sortedLogs[0].logged_at_date);

            sortedLogs.forEach(log => {
                if (log.logged_at_date >= weekStartDate && log.logged_at_date < addDays(weekStartDate, 7)) {
                    currentWeek.push(log);
                } else {
                    if (currentWeek.length > 0) weeks.push(currentWeek);
                    currentWeek = [log];
                    weekStartDate = getStartOfWeek(log.logged_at_date);
                }
            });
            if (currentWeek.length > 0) weeks.push(currentWeek);
            return weeks;
        }

        function getStartOfWeek(date) { // Monday as start of week
            const d = new Date(date);
            const day = d.getDay(); // Sunday - 0, Monday - 1, ...
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Adjust to Monday
            return new Date(d.setDate(diff));
        }

        function addDays(date, days) {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }

        function formatDate(date) { // For comparing dates, ignoring time
            return date.toISOString().split('T')[0];
        }

        function setupChartAndSlider() {
            const ctx = document.getElementById('moodScoreChart').getContext('2d');
            const thresholdPlugin = { /* ... as before ... */ id:'thresholdPlugin', beforeDraw(c){ const {ctx,chartArea:{left,right},scales:{y}} = c; const {min,max} = c.config.options.thresholds; if(min === undefined || max === undefined) return; ctx.save(); ctx.setLineDash([6,4]); ctx.strokeStyle='crimson'; ctx.beginPath(); ctx.moveTo(left,y.getPixelForValue(min)); ctx.lineTo(right,y.getPixelForValue(min)); ctx.stroke(); ctx.strokeStyle='seagreen'; ctx.beginPath(); ctx.moveTo(left,y.getPixelForValue(max)); ctx.lineTo(right,y.getPixelForValue(max)); ctx.stroke(); ctx.restore(); } };
            const syncHeight = { /* ... as before ... */ id:'syncHeight', afterLayout(c){ const sliderEl = document.getElementById('slider'); const y = c.scales.y; const top = y.getPixelForValue(c.options.scales.y.max); const bot = y.getPixelForValue(c.options.scales.y.min); const OFF = 0; sliderEl.style.marginTop = (top-OFF)+'px'; sliderEl.style.height = (bot-top+OFF*2)+'px'; } };

            moodChartInstance = new Chart(ctx, {
                type: 'line',
                data: { datasets: [{ label: 'Mood Score', data: [], fill: true, tension: 0.3, pointRadius: 5 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { type: 'time', time: { unit: 'day', tooltipFormat: 'MMM dd', displayFormats: { day: 'MMM dd' } }, grid: { display: false } },
                        y: { min: 1, max: 5, grid: { drawBorder: false }, ticks: { stepSize: 1 } }
                    },
                    plugins: { legend: { display: false }, zoom: { pan: { enabled: true, mode: 'x' }, zoom: { wheel: { enabled: false }, pinch: { enabled: false } } } },
                    thresholds: { min: 1, max: 5 } // Initial thresholds
                },
                plugins: [syncHeight, thresholdPlugin]
            });

            slider = document.getElementById('slider');
            if (slider.noUiSlider) slider.noUiSlider.destroy();
            noUiSlider.create(slider, {
                start: [1, 5], connect: true, orientation: 'vertical', direction: 'rtl',
                range: { 'min': 1, 'max': 5 }, step: 0.1,
                tooltips: [
                    { to: value => parseFloat(value).toFixed(1) }, // Formatter for lower handle
                    { to: value => parseFloat(value).toFixed(1) }  // Formatter for upper handle
                ]
                // format: { to: v => v.toFixed(1), from: v => +v } // Simpler alternative if both same format
            });

            slider.noUiSlider.on('update', ([minStr, maxStr]) => {
                const minThreshold = parseFloat(minStr);
                const maxThreshold = parseFloat(maxStr);

                if (moodChartInstance) {
                    moodChartInstance.options.thresholds.min = minThreshold;
                    moodChartInstance.options.thresholds.max = maxThreshold;
                    // Point recoloring will happen in updateView or directly if needed
                    moodChartInstance.update('none'); // Update chart for threshold lines
                }
                updatePanels(currentWeekIndex, minThreshold, maxThreshold); // Update panels on slider change
            });
             // Apply initial theme colors to chart after creation
            if(themeToggle.checked) { // If dark mode is initially active
                const event = new Event('change');
                themeToggle.dispatchEvent(event); // Trigger change to apply dark theme colors
            } else { // Apply light theme colors explicitly if not dark
                moodChartInstance.options.scales.x.ticks.color = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
                moodChartInstance.options.scales.y.ticks.color = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim();
                moodChartInstance.options.scales.y.grid.color = getComputedStyle(document.documentElement).getPropertyValue('--shadow-dark').trim();
                moodChartInstance.data.datasets[0].borderColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-line').trim();
                moodChartInstance.data.datasets[0].backgroundColor = makeGradient(moodChartInstance.ctx);
                moodChartInstance.update('none');
            }
        }

        function makeGradient(ctx) { /* ... as before ... */ const h = ctx.canvas.height || 300; const g = ctx.createLinearGradient(0,0,0,h); const root = getComputedStyle(document.documentElement); const s = root.getPropertyValue('--chart-grad-start').trim() || 'rgba(54,162,235,0.6)'; const e = root.getPropertyValue('--chart-grad-end').trim() || 'rgba(54,162,235,0.1)'; g.addColorStop(0,s); g.addColorStop(1,e); return g; }
        
        function getWeekMoodData(weekIdx) { // Provides data for the chart line (daily averages)
            if (weekIdx < 0 || weekIdx >= weekSegments.length || !weekSegments[weekIdx]) return [];
            const currentWeekLogs = weekSegments[weekIdx];
            if (!currentWeekLogs.length) return [];

            const weekStartDate = getStartOfWeek(currentWeekLogs[0].logged_at_date);
            weekStartDate.setHours(0,0,0,0); // Normalize to start of day

            const dailyAverages = [];
            for (let i = 0; i < 7; i++) {
                const day = addDays(weekStartDate, i);
                day.setHours(0,0,0,0); // Normalize current day for comparison

                const logsForThisDay = currentWeekLogs.filter(log => {
                    const logDateOnly = new Date(log.logged_at_date);
                    logDateOnly.setHours(0,0,0,0); // Normalize log date
                    return logDateOnly.getTime() === day.getTime() &&
                           log.mood_score !== null && log.mood_score !== undefined;
                });

                if (logsForThisDay.length > 0) {
                    const sum = logsForThisDay.reduce((acc, log) => acc + log.mood_score, 0);
                    const avg = sum / logsForThisDay.length;
                    dailyAverages.push({ x: luxon.DateTime.fromJSDate(day).valueOf(), y: avg });
                } else {
                    dailyAverages.push({ x: luxon.DateTime.fromJSDate(day).valueOf(), y: null });
                }
            }
            return dailyAverages;
        }

        function updateView() {
            if (!moodChartInstance || !slider) return; // Ensure chart and slider are initialized

            const weekMoodDataForChart = getWeekMoodData(currentWeekIndex);
            moodChartInstance.data.datasets[0].data = weekMoodDataForChart;
             // Update chart line/fill colors based on current theme
            moodChartInstance.data.datasets[0].borderColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-line').trim();
            moodChartInstance.data.datasets[0].backgroundColor = makeGradient(moodChartInstance.ctx);


            if (weekSegments.length > 0 && currentWeekIndex < weekSegments.length && weekSegments[currentWeekIndex].length > 0) {
                const weekStartDate = getStartOfWeek(weekSegments[currentWeekIndex][0].logged_at_date);
                const weekEndDate = addDays(weekStartDate, 6);
                document.getElementById('segmentLabel').textContent =
                    `${luxon.DateTime.fromJSDate(weekStartDate).toFormat('LLL dd')} – ${luxon.DateTime.fromJSDate(weekEndDate).toFormat('LLL dd')}`;
            } else if (weekSegments.length > 0) {
                 document.getElementById('segmentLabel').textContent = 'No mood data for this selected week';
            }
            else {
                document.getElementById('segmentLabel').textContent = 'No data available';
            }

            document.getElementById('prevWeekBtn').disabled = currentWeekIndex === 0;
            document.getElementById('nextWeekBtn').disabled = currentWeekIndex >= weekSegments.length - 1;

            const [minStr, maxStr] = slider.noUiSlider.get(); // Get current values
            const minThreshold = parseFloat(minStr);
            const maxThreshold = parseFloat(maxStr);
            
            updatePanels(currentWeekIndex, minThreshold, maxThreshold);

            // Recolor points on chart
            const baseColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-line').trim();
            const highlightColor = 'seagreen'; // Or a CSS variable for highlight
            moodChartInstance.data.datasets[0].pointBackgroundColor =
                weekMoodDataForChart.map(point => {
                    return (point.y !== null && point.y >= minThreshold && point.y <= maxThreshold) ? highlightColor : baseColor;
                });

            moodChartInstance.update();
        }

        function updatePanels(weekIdx, minMoodThreshold, maxMoodThreshold) {
            const currentWeekLogs = (weekIdx < weekSegments.length && weekSegments[weekIdx]) ? weekSegments[weekIdx] : [];

            const filteredLogsForPanels = currentWeekLogs.filter(log =>
                log.mood_score !== null && log.mood_score !== undefined &&
                log.mood_score >= minMoodThreshold && log.mood_score <= maxMoodThreshold
            );

            const dietPanel = document.getElementById('dietPanel');
            let dietHtml = ''; let dietDataFound = false;
            filteredLogsForPanels.forEach(log => {
                if (log.diet && typeof log.diet === 'object' && Object.keys(log.diet).length > 0) {
                    dietDataFound = true;
                    for (const category in log.diet) {
                        if (log.diet[category] && log.diet[category].length > 0) {
                            dietHtml += `<div><strong>${escapeHtml(category.replace(/_/g, " "))}:</strong> ${log.diet[category].map(item => `<span class="tag">${escapeHtml(item)}</span>`).join(' ')}</div>`;
                        }
                    }
                }
            });
            dietPanel.innerHTML = dietDataFound ? dietHtml : `<span style="color:var(--text-color); opacity:0.6;">No dietary data for this mood range.</span>`;

            const healthPanel = document.getElementById('healthPanel');
            let healthHtml = ''; let healthDataFound = false;
            filteredLogsForPanels.forEach(log => {
                if (log.health && log.health.length > 0) {
                    healthDataFound = true;
                    // healthHtml += `<div>${log.health.map(h => `<span class="tag">${escapeHtml(h)}</span>`).join(' ')}</div>`;
                    log.health.forEach(h => { healthHtml += `<span class="tag">${escapeHtml(h)}</span> `;});
                }
            });
            if(healthHtml) healthPanel.innerHTML = `<div>${healthHtml.trim()}</div>`;
            else healthPanel.innerHTML = `<span style="color:var(--text-color); opacity:0.6;">No health data for this mood range.</span>`;


            const activityPanel = document.getElementById('activityPanel');
            let activityHtml = ''; let activityDataFound = false;
            filteredLogsForPanels.forEach(log => {
                if (log.activity && log.activity.length > 0) {
                    activityDataFound = true;
                    // activityHtml += `<div>${log.activity.map(a => `<span class="tag">${escapeHtml(a)}</span>`).join(' ')}</div>`;
                    log.activity.forEach(a => { activityHtml += `<span class="tag">${escapeHtml(a)}</span> `;});
                }
            });

            if(activityHtml) activityPanel.innerHTML = `<div>${activityHtml.trim()}</div>`;
            else activityPanel.innerHTML = `<span style="color:var(--text-color); opacity:0.6;">No activity data for this mood range.</span>`;
        }

        function displayLogEntries(logsToDisplay) {
            const container = document.getElementById('logsContainer');
            container.innerHTML = '';
            if (logsToDisplay && logsToDisplay.length > 0) {
                [...logsToDisplay].reverse().forEach(log => { // Display newest first
                    const entryDiv = document.createElement('div');
                    entryDiv.className = 'log-entry';
                    let htmlContent = `<div class="log-meta">Logged: ${luxon.DateTime.fromJSDate(log.logged_at_date).toFormat('yyyy-MM-dd HH:mm')}</div>`;
                    if(log.original_note) {
                        htmlContent += `<div class="log-original-note"><strong>Original:</strong> ${escapeHtml(log.original_note)}</div>`;
                    }
                    if (log.mood_label) {
                        htmlContent += `<div class="log-section"><h3>Mood</h3><span class="tag">${escapeHtml(log.mood_label)} (${log.mood_score !== null && log.mood_score !== undefined ? log.mood_score : 'N/A'})</span></div>`;
                    }
                    if (log.health && log.health.length > 0) {
                        htmlContent += `<div class="log-section"><h3>Health</h3>${log.health.map(h => `<span class="tag">${escapeHtml(h)}</span>`).join(' ')}</div>`;
                    }
                    if (log.activity && log.activity.length > 0) {
                        htmlContent += `<div class="log-section"><h3>Activity</h3>${log.activity.map(a => `<span class="tag">${escapeHtml(a)}</span>`).join(' ')}</div>`;
                    }
                    if (log.diet && typeof log.diet === 'object' && Object.keys(log.diet).length > 0) {
                        htmlContent += `<div class="log-section"><h3>Diet</h3>`;
                        for (const category in log.diet) {
                            if (log.diet[category] && log.diet[category].length > 0) {
                                htmlContent += `<div style="margin-left:10px;"><strong>${escapeHtml(category.replace(/_/g, " "))}:</strong> ${log.diet[category].map(item => `<span class="tag">${escapeHtml(item)}</span>`).join(' ')}</div>`;
                            }
                        }
                        htmlContent += `</div>`;
                    }
                    entryDiv.innerHTML = htmlContent;
                    container.appendChild(entryDiv);
                });
            } else {
                container.innerHTML = '<p style="text-align:center;">No logs found yet for this user.</p>';
            }
        }

        function escapeHtml(unsafe) { /* ... as before ... */ if (typeof unsafe !== 'string') return ''; return unsafe.replace(/&/g, "&").replace(/</g, "<").replace(/>/g, ">").replace(/"/g, """).replace(/'/g, "'"); }
    </script>
</body>
</html>

